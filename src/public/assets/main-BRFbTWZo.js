import{resolveComponent as q,createElementBlock as i,openBlock as r,createElementVNode as l,createTextVNode as u,createCommentVNode as h,withModifiers as C,createBlock as b,withDirectives as y,vModelText as S,Fragment as _,renderList as w,normalizeStyle as f,normalizeClass as x,toDisplayString as k}from"vue";let I=biigle.$require("events"),v=biigle.$require("handleErrorResponse"),R=biigle.$require("core.components.loader"),$=biigle.$require("core.mixins.loader"),N=biigle.$require("resource"),E=biigle.$require("volumes.mixins.sortComponent"),p=biigle.$require("volumes.stores.sorters");const d=N("api/v1/volumes{/volume_id}/color-sort-sequence{/color}"),g=(t,e)=>{const c=t.__vccOpts||t;for(const[a,s]of e)c[a]=s;return c},A={emits:["select"],mixins:[E],components:{loader:R},data(){return{title:"Sort images by color",text:"Color",volumeId:null,fetchingColors:!0,colors:[],activeColor:null,cache:{},loadingSequence:!1,computingSequence:!1,newColor:"#000000",canEdit:!1}},computed:{hasColors(){return this.colors.length>0},id(){return"color-"+this.activeColor},active(){return this.activeSorter.startsWith("color-")},canRequestNewColor(){return!this.fetchingColors&&!this.loadingSequence&&!this.computingSequence}},methods:{getSequence(){let t=this.activeColor;return this.cache.hasOwnProperty(t)?new Promise(e=>{e(this.cache[t])}):(this.loadingSequence=!0,d.get({volume_id:this.volumeId,color:t}).then(this.parseResponse).then(e=>(this.cache[t]=e,e)).finally(()=>this.loadingSequence=!1))},parseResponse(t){return t.data},initColors(t){this.colors=t.data},select(t){!this.isActive(t)&&!this.loadingSequence&&(this.activeColor=t,this.$emit("select",this))},isActive(t){return this.active&&t===this.activeColor},fetchColors(){d.query({volume_id:this.volumeId}).then(this.initColors).catch(v).finally(()=>this.fetchingColors=!1)},pollNewSequence(t){let e=t.body.color;return new Promise((c,a)=>{let s=window.setInterval(()=>{d.get({volume_id:this.volumeId,color:e}).then(function(o){o.data&&(window.clearInterval(s),c(o))},function(o){window.clearInterval(s),o.status===404&&(o.body.message="Computing the color sort sequence failed. Sorry."),a(o)})},2500)})},requestNewColor(){this.computingSequence=!0;let t=this.newColor.substr(1);d.save({volume_id:this.volumeId},{color:t}).then(this.pollNewSequence).then(e=>{this.cache[t]=e.data,this.colors.push(t),this.select(t)}).catch(v).finally(()=>this.computingSequence=!1)}},created(){this.volumeId=biigle.$require("volumes.volumeId"),this.canEdit=biigle.$require("volumes.canEdit")},mounted(){I.once("sidebar.open.sorting",this.fetchColors),this.active&&(this.activeColor=this.activeSorter.substr(this.activeSorter.indexOf("-")+1))}},L={class:"list-group-item color-sort-list-group-item",title:"Sort images by color"},O={class:"clearfix"},V={key:0,class:"pull-right"},D=["disabled"],j={key:1,class:"text-muted"},B={key:2,class:"text-muted"},M={key:0,class:"list-unstyled available-colors-list"},P=["onClick"];function z(t,e,c,a,s,o){const m=q("loader");return r(),i("span",L,[l("div",O,[s.canEdit?(r(),i("span",V,[l("form",{onSubmit:e[1]||(e[1]=C((...n)=>o.requestNewColor&&o.requestNewColor(...n),["prevent"]))},[s.computingSequence?(r(),b(m,{key:0,active:s.computingSequence},null,8,["active"])):h("",!0),e[3]||(e[3]=u()),y(l("input",{type:"color",class:"btn btn-default btn-xs color-picker",id:"color-sort-color","onUpdate:modelValue":e[0]||(e[0]=n=>s.newColor=n),title:"Choose a new color"},null,512),[[S,s.newColor]]),e[4]||(e[4]=u()),l("button",{disabled:!o.canRequestNewColor||null,type:"submit",class:"btn btn-default btn-xs",title:"Request a new color sort sequence for the chosen color"},e[2]||(e[2]=[l("span",{class:"fa fa-plus","aria-hidden":"true"},null,-1)]),8,D)],32)])):h("",!0),e[5]||(e[5]=u(`
            Color
            `)),s.fetchingColors?(r(),i("span",j,`
                (fetching colors...)
            `)):o.hasColors?h("",!0):(r(),i("span",B,`
                (no colors available)
            `))]),e[6]||(e[6]=u()),o.hasColors?(r(),i("ul",M,[(r(!0),i(_,null,w(s.colors,n=>(r(),i("li",{class:x(["available-colors-item",{active:o.isActive(n)}]),style:f({"background-color":"#"+n}),title:"Sort by this color",onClick:Q=>o.select(n)},null,14,P))),256))])):h("",!0)])}const T=g(A,[["render",z]]),F={emits:["remove"],props:{sequence:{type:Object,required:!0}},computed:{title(){return"Delete sequence for color #"+this.color},styleObject(){return{"background-color":"#"+this.color}},color(){return this.sequence.color}},methods:{remove(){this.$emit("remove",this.sequence)}}},U={class:"list-group-item"},W=["title"],G=["textContent"];function H(t,e,c,a,s,o){return r(),i("li",U,[l("button",{type:"button",class:"close",title:o.title,onClick:e[0]||(e[0]=(...m)=>o.remove&&o.remove(...m))},e[1]||(e[1]=[l("span",{"aria-hidden":"true"},"Ã—",-1)]),8,W),e[2]||(e[2]=u()),l("span",{class:"color-sort-sequence-color",style:f(o.styleObject)},null,4),e[3]||(e[3]=u("#")),l("span",{textContent:k(o.color)},null,8,G)])}const J=g(F,[["render",H]]),K={mixins:[$],data(){return{sequences:[],volumeId:null}},components:{listItem:J},computed:{hasSequences(){return this.sequences.length>0}},methods:{handleRemove(t){!this.loading&&confirm(`Do you really want to delete the sequence for color #${t.color}?`)&&(this.startLoading(),d.delete({volume_id:this.volumeId,color:t.color}).then(()=>this.sequenceRemoved(t.id)).catch(v).finally(this.finishLoading))},sequenceRemoved(t){this.sequences=this.sequences.filter(e=>e.id!==t)}},created(){this.sequences=biigle.$require("volumes.colorSortSequences").map((t,e)=>({color:t,id:e})),this.volumeId=biigle.$require("volumes.id")}};Array.isArray(p)&&p.push({id:"color",types:["image"],component:T});biigle.$mount("color-sort-panel",K);
