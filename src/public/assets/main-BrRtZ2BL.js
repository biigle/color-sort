import{resolveComponent as g,createElementBlock as l,openBlock as s,createElementVNode as c,createTextVNode as h,createCommentVNode as d,withModifiers as f,createBlock as q,withDirectives as C,vModelText as b,Fragment as S,renderList as y,normalizeStyle as w,normalizeClass as _}from"vue";let x=biigle.$require("events"),m=biigle.$require("handleErrorResponse"),I=biigle.$require("core.components.loader"),k=biigle.$require("core.mixins.loader"),R=biigle.$require("resource"),N=biigle.$require("volumes.mixins.sortComponent"),v=biigle.$require("volumes.stores.sorters");const u=R("api/v1/volumes{/volume_id}/color-sort-sequence{/color}"),E=(e,t)=>{const n=e.__vccOpts||e;for(const[a,r]of t)n[a]=r;return n},$={mixins:[N],components:{loader:I},data(){return{title:"Sort images by color",text:"Color",volumeId:null,fetchingColors:!0,colors:[],activeColor:null,cache:{},loadingSequence:!1,computingSequence:!1,newColor:"#000000",canEdit:!1}},computed:{hasColors(){return this.colors.length>0},id(){return"color-"+this.activeColor},active(){return this.activeSorter.startsWith("color-")},canRequestNewColor(){return!this.fetchingColors&&!this.loadingSequence&&!this.computingSequence}},methods:{getSequence(){let e=this.activeColor;return this.cache.hasOwnProperty(e)?new Promise(t=>{t(this.cache[e])}):(this.loadingSequence=!0,u.get({volume_id:this.volumeId,color:e}).then(this.parseResponse).then(t=>(this.cache[e]=t,t)).finally(()=>this.loadingSequence=!1))},parseResponse(e){return e.data},initColors(e){this.colors=e.data},select(e){!this.isActive(e)&&!this.loadingSequence&&(this.activeColor=e,this.$emit("select",this))},isActive(e){return this.active&&e===this.activeColor},fetchColors(){u.query({volume_id:this.volumeId}).then(this.initColors).catch(m).finally(()=>this.fetchingColors=!1)},pollNewSequence(e){let t=e.body.color;return new Promise((n,a)=>{let r=window.setInterval(()=>{u.get({volume_id:this.volumeId,color:t}).then(function(o){o.data&&(window.clearInterval(r),n(o))},function(o){window.clearInterval(r),o.status===404&&(o.body.message="Computing the color sort sequence failed. Sorry."),a(o)})},2500)})},requestNewColor(){this.computingSequence=!0;let e=this.newColor.substr(1);u.save({volume_id:this.volumeId},{color:e}).then(this.pollNewSequence).then(t=>{this.cache[e]=t.data,this.colors.push(e),this.select(e)}).catch(m).finally(()=>this.computingSequence=!1)}},created(){this.volumeId=biigle.$require("volumes.volumeId"),this.canEdit=biigle.$require("volumes.canEdit")},mounted(){x.$once("sidebar.open.sorting",this.fetchColors),this.active&&(this.activeColor=this.activeSorter.substr(this.activeSorter.indexOf("-")+1))}},A={class:"list-group-item color-sort-list-group-item",title:"Sort images by color"},L={class:"clearfix"},V={key:0,class:"pull-right"},O=["disabled"],B={key:1,class:"text-muted"},D={key:2,class:"text-muted"},M={key:0,class:"list-unstyled available-colors-list"},P=["onClick"];function z(e,t,n,a,r,o){const p=g("loader");return s(),l("span",A,[c("div",L,[r.canEdit?(s(),l("span",V,[c("form",{onSubmit:t[1]||(t[1]=f((...i)=>o.requestNewColor&&o.requestNewColor(...i),["prevent"]))},[r.computingSequence?(s(),q(p,{key:0,active:r.computingSequence},null,8,["active"])):d("",!0),t[3]||(t[3]=h()),C(c("input",{type:"color",class:"btn btn-default btn-xs color-picker",id:"color-sort-color","onUpdate:modelValue":t[0]||(t[0]=i=>r.newColor=i),title:"Choose a new color"},null,512),[[b,r.newColor]]),t[4]||(t[4]=h()),c("button",{disabled:!o.canRequestNewColor,type:"submit",class:"btn btn-default btn-xs",title:"Request a new color sort sequence for the chosen color"},t[2]||(t[2]=[c("span",{class:"fa fa-plus","aria-hidden":"true"},null,-1)]),8,O)],32)])):d("",!0),t[5]||(t[5]=h(`
            Color
            `)),r.fetchingColors?(s(),l("span",B,`
                (fetching colors...)
            `)):o.hasColors?d("",!0):(s(),l("span",D,`
                (no colors available)
            `))]),t[6]||(t[6]=h()),o.hasColors?(s(),l("ul",M,[(s(!0),l(S,null,y(r.colors,i=>(s(),l("li",{class:_(["available-colors-item",{active:o.isActive(i)}]),style:w({"background-color":"#"+i}),title:"Sort by this color",onClick:U=>o.select(i)},null,14,P))),256))])):d("",!0)])}const T=E($,[["render",z]]);let j={props:["sequence"],computed:{title(){return"Delete sequence for color #"+this.color},styleObject(){return{"background-color":"#"+this.color}},color(){return this.sequence.color}},methods:{remove(){this.$emit("remove",this.sequence)}}};const F={mixins:[k],data(){return{sequences:[],volumeId:null}},components:{listItem:j},computed:{hasSequences(){return this.sequences.length>0}},methods:{handleRemove(e){!this.loading&&confirm(`Do you really want to delete the sequence for color #${e.color}?`)&&(this.startLoading(),u.delete({volume_id:this.volumeId,color:e.color}).then(()=>this.sequenceRemoved(e.id)).catch(m).finally(this.finishLoading))},sequenceRemoved(e){this.sequences=this.sequences.filter(t=>t.id!==e)}},created(){this.sequences=biigle.$require("volumes.colorSortSequences").map((e,t)=>({color:e,id:t})),this.volumeId=biigle.$require("volumes.id")}};Array.isArray(v)&&v.push({id:"color",types:["image"],component:T});biigle.$mount("color-sort-panel",F);
